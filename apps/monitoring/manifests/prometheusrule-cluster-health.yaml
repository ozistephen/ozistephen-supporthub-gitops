apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cluster-health
  namespace: monitoring
  labels:
    release: monitoring
spec:
  groups:
    - name: cluster-health.rules
      rules:
        # 1) Pod CrashLooping
        - alert: PodCrashLooping
          expr: |
            max_over_time(kube_pod_container_status_waiting_reason{reason="CrashLoopBackOff"}[5m]) >= 1
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Pod is crash looping"
            description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} container {{ $labels.container }} is in CrashLoopBackOff."

        # 2) Deployment replicas mismatch
        - alert: KubeDeploymentReplicasMismatch
          expr: |
            kube_deployment_spec_replicas != kube_deployment_status_replicas_available
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Deployment replicas mismatch"
            description: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has mismatched desired vs available replicas."

        # 3) PVC nearly full (uses kubelet volume stats)
        - alert: PVCNearlyFull
          expr: |
            (kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes) < 0.15
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "PVC nearly full (<15% free)"
            description: "PVC {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is running low on space."

        # 4) Node disk pressure (filesystem)
        - alert: NodeDiskAlmostFull
          expr: |
            (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) < 0.10
          for: 15m
          labels:
            severity: critical
          annotations:
            summary: "Node disk almost full (<10% free)"
            description: "Node {{ $labels.instance }} filesystem {{ $labels.mountpoint }} is low on space."

        # 5) High CPU saturation (node)
        - alert: NodeHighCPU
          expr: |
            (1 - avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m]))) > 0.90
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High node CPU usage (>90%)"
            description: "Node {{ $labels.instance }} CPU usage is above 90%."

        # 6) High memory saturation (node)
        - alert: NodeHighMemory
          expr: |
            (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.90
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High node memory usage (>90%)"
            description: "Node {{ $labels.instance }} memory usage is above 90%."
